---
id: 489
title: 'Создание небольшой локальной сети с помощью Ubuntu'
date: '2015-11-01T18:08:58+02:00'
author: 'Андрей Гуцу'
layout: revision
guid: 'https://glowingsword.ru/254-revision-v1/'
permalink: '/?p=489'
---

<h3> Настройка интерфейсов</h3>
<p>Хотите превратить ваш ПК в маршрутизатор для небольшой локальной сети? Я опишу процесс создания сети в серии записей в моём блоге. Эта, вступительная часть, описывает настройку интерфейсов и NAT. В следующих частях я опишу установку и настройку DHCP-сервера, настройку DNS-кеширования, а так-же настройку прокси-сервера для нашей локальной сети. </p>

<p>Ну, приступим... Для начала вы должны определить, какой сетевой интерфейс(сетевая карта и т.п.) смотрит в создаваемую вами локальную сеть, а какой - в сеть дающую вам доступ в интернет. Сделать это можно командой:</p> 
<pre>
<code class="bash">
  sudo ifconfig
</code>
</pre>
<!--more-->
<p>Для примера я выбрал свою домашнюю сеть. В ней есть кабель от интернет-провайдера, маршрутизатор TP-LINK, раздающий интернет по WiFi, и от него кабель к ПК на с установленной на него ОС Ubuntu. Интернет я получаю из сети, которой рулит этот маршрутизатор. Это сеть 192.168.3.1. У вас это может быть внутридомовая сеть, сеть провайдера и т.п. Важно, что мой ПК(который я превращаю в маршрутизатор) подключен к данной сети через интерфейс eth0. А раздавать интернет мы будем на узлы создаваемой нами локальной сети через интерфейс eth1, как показано на изображении:</p>
<a href="https://glowingsword.ru/wp-content/uploads/2013/03/Маршрутизатор-на-базе-Ubuntu.png"><img src="https://glowingsword.ru/wp-content/uploads/2013/03/Маршрутизатор-на-базе-Ubuntu-300x143.png" alt="Маршрутизатор на базе Ubuntu" width="300" height="143" class="aligncenter size-medium wp-image-255" /></a>

<p>Вы уже разобрались, какой интерфейс у вас смотрит в вашу локальную сеть(которую вы создаёте), а какой во внешнюю сеть(из которой вы получаете интернет)? Читая данное руководство помните, что вы должны eth0 заменять на ваш интерфейс смотрящий в сеть, откуда вы получаете интернет. А eth1 заменяем на интерфейс, через который ваш маршрутизатор подключен в создаваемую вами локальную сеть.</p>
 
<p>Будем считать, что раз вы уже имеете доступ в интернет, значит интерфейс eth0 уже настроен. Остаётся настроить интерфейс eth1(смотрящий в нашу локальную сеть), что мы и сделаем.</p>

<p>Редактируем файл /etc/network/interfaces(командой sudo gedit /etc/network/interfaces), добавляем в него описание настроек интерфейса eth1:</p>
<pre>
<code class="bash">
auto eth1
iface eth1 inet static
address 192.168.0.1
netmask 255.255.255.0
network 192.168.0.0
broadcast 192.168.0.255
</code>
</pre>
<p>
Где:<br /> 
iface - сетевой интерфейс, смотрящий в локальную сеть. 
address -  IP-адресс вашей машины в локальной сети.
netmask - маска сети, определяющая часть IP-адресса отвечающую за адрес сети, в которой расположен данный IP, и часть отвечающую за адресс конкретной машины в этой сети.
network - адрес создаваемой нами локальной сети
broadcast - широковещательный адрес(подробнее о адресах, используемых в сети я писал в посте “Термины, используемые при настройки сети”). </p>

<p>Перезапускаем networking командой:</p>
<pre>
<code class="bash">
  sudo service networking restart
</code>
</pre>

<p>Командой ifconfig проверяем, что наши изменения вступили в силу.</p>

<h3>Настройка NAT(преобразования сетевых адресов)</h3>

<p>Сеть так устроена, что каждый интерфейс слушает только пакеты, адресованные ему, и отбрасывает пакеты, которые адресуются интерфейсам на других адресах. Для того, что-бы пакеты адресованные интерфейсу eth1 перенаправлялись на интерфейс eth0(другими словами чтобы узлы из локальной сети могли обращаться к узлам из внешней сети), нужно настроить NAT.</p>

<p>Включаем поддержку перенаправления портов
Включите перенаправление портов. Откройте файл  <i>/etc/sysctl.conf</i>:</p>
<pre>
<code ="bash">
sudo gedit /etc/sysctl.conf
</code>
</pre>

<p>Найдите строку <i>“net.ipv4.ip_forward = 0”</i> и измените <b>0</b> на <b>1</b>. Строка должна иметь такой вид:</p>
<pre>
<code class="bash">
net.ipv4.ip_forward = 1
</code>
</pre>
<p>Если по какой-то причине данная строка отсутствует, добавьте её. Внесённые изменения вступят в силу после перезагрузки. Что-бы лишний раз не перезагружаться, в консоли выполните команду:</p>
<pre>
<code class="bash">
 sudo sysctl -p
</code>
</pre>
или
<pre>
<code class="bash">
  sudo sh -c ‘echo 1 > /proc/sys/net/ipv4/ip_forward’
</code>
</pre>
<h3>Настройка правил iptables для работы NAT</h3>
<p>Важно: Если вы уже пытались настроить раньше сеть, и прописали какие-то правила для вашего интерфейса, смотрящего в локальную сеть - возможно вам прийдётся их очистить перед установкой новых правил. И убедитесь, что у вас установлен пакет iptables.</p>

<p>Прописываем правила для преобразования сетевых адресов(NAT).  По этому правилу исходящие через интерфейс eth0 сообщения(пакеты) будут изменяться таким образом, что адрес инициатора сообщения будет подменяться адресом маршрутизатора, служащего посредником в общении узлов из разных сетей. </p>
<pre>
<code class="bash">
  sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
</code>
</pre>

<p>Так-же мы должны добавить правило, которое позволит нам перенаправлять запросы с интерфейса eth1 на eth0:</p>
<pre>
<code class="bash">
  sudo iptables -I FORWARD -i eth1 -o eth0 -j ACCEPT
</code>
</pre>

<p>И правило, позволяющее пакетам с интерфейса eth0 перенаправляться на eth1, если соединение было установлено по инициативе узла из локальной сети:</p>
<pre>
<code class="bash">
  sudo iptables -A FORWARD -i eth0 -o eth1 -m state --state RELATED,ESTABLISHED -j ACCEPT
</code>
</pre>

После перезагрузки правила iptables прийдётся задавать заново. Что-бы не делать этого вручную, сохраните их:
<pre>
<code class="bash">
sudo sh -c 'iptables-save > /etc/iptables.up.rules'
</code>
</pre>
И добавьте в конец файла /etc/network/interfaces строку, которая будет автоматически восстанавливать ваши правила перед поднятием сетевого интерфейса:
<pre>
<code class="bash">
pre-up iptables-restore < /etc/iptables.up.rules
</code>
</code></pre>
<p>Теперь достаточно указать сетевые настроки на узлах нашей локальной сети, и всё заработает. Указываем следующие настройки:
<ul>
<li>address - IP-адрес в диапазоне 192.168.0.2-192.168.0.254</li><li></li>
<li>netmask - маска сети, 255.255.255.0<br />
</li><li>gateway - адрес шлюза(маршрутизатора), которым в созданной вами сети служит настроенный вами маршрутизатор на Ubuntu. Его адрес - 192.168.0.1</li><li></li>
<li>DNS - укажите адрес DNS-сервера(или нескольких).В качестве DNS-сервера вы можете указать:
<ul>
<li>Google DNS(8.8.8.8, 8.8.4.4)</li>
<li>любой другой публичный DNS</li>
<li>DNS-сервер(сервера) вашего интернет-провайдера</li>
<li>DNS-сервер сети, к которой подключен ваш маршрутизатор.</li><li></li></ul></li></ul></p>
<p>Поздравляю, ваша сеть настроена. Можете с чувством выполненного долга идти пить чай. </p><p></p>